---
title: "Aquasat_LAGOS_NHD_LakeCat_Merge: This code creates a training set for prediction of chlorophyll-a and/or categorical predictions (i.e. oligotrophic/mesotrophic/eutrophic). Lake point data (i.e. Aquasat and LAGOS), that do not contain common identifiers, are merged to nhd lake polygons to prevent potentially incorrect spatial joins. This can occur due to clustered lakes and inconsistent lake points. The combined Aquasat/LAGOS/NHD file is then merged to lakeCat data by the common identifier comid"
date: 3-30-2022
author: S.Sillen
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Required packages
```{r}
library(tidyverse)
library(lubridate)
library(sf)
library(leaflet)
library(leafgl)
library(nngeo)
library(nhdplusTools)

baseDir <- "~/Dropbox (1)"
```

#General outline / workflow 
```{r}
## Read in AquaSat and filter to area of interest (aoi) and parameters of interest (chl-a)

## Pull out the nhd waterbodies within the aoi (contains polygon data for joins)

## Use nhd polygon data to join datasets that do not share commmon identifiers together 

## Read in LakeCat variables and join via COMID (shared identifier between NHD and LakeCat)
 ```

# Load in LAGOS/Aquasat data and filter it to roi (intermoutnain west states: WY,CO,UT,ID,MT). Filter Aquasat data to only include chl-a data.
```{r}

lagos_aoi <- read.csv(paste0(baseDir,"/CL_LAGOSUS_exports/LAGOSUS_LOCUS/LOCUS_v1.0/lake_information.csv")) %>%
  filter(lake_centroidstate == 'WY' | lake_centroidstate == 'CO' | lake_centroidstate == 'ID' | lake_centroidstate == 'MT' | lake_centroidstate == 'UT') %>%
  st_as_sf(coords=c("lake_lon_decdeg","lake_lat_decdeg"), crs=4326, remove=FALSE)  
  
#Aquasat does not include state field, so use min/max lat longs for states in aoi to filter lat long data then bind together. 

#COLORADO
co_min_lat = 36.9949
co_max_lat = 41.0006
co_min_long = -109.0489
co_max_long = -102.0424

aquasat_co <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>% 
   filter(lat >= co_min_lat & lat <= co_max_lat) %>% 
   filter(long >= co_min_long & long <= co_max_long) 

#IDAHO
id_min_lat = 41.9871
id_max_lat = 49.0018
id_min_long = -117.2372
id_max_long = -111.0471

aquasat_id <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>%
   filter(lat >= id_min_lat & lat <= id_max_lat) %>% 
   filter(long >= id_min_long & long <= id_max_long) 
   
#MONTANA
mt_min_lat = 44.3563
mt_max_lat = 48.9991
mt_min_long = -116.0458
mt_max_long = -104.0186

aquasat_mt <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>% 
   filter(lat >= mt_min_lat & lat <= mt_max_lat) %>% 
   filter(long >= mt_min_long & long <= mt_max_long) 

#UTAH
ut_min_lat = 36.9982
ut_max_lat = 41.9993
ut_min_long = -114.0504
ut_max_long = -109.0462

aquasat_ut <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>%
   filter(lat >= ut_min_lat & lat <= ut_max_lat) %>% 
   filter(long >= ut_min_long & long <= ut_max_long) 

#WYOMING
wy_min_lat =  40.9986
wy_max_lat = 44.9988
wy_max_long =  -104.0556
wy_min_long = -111.0539

aquasat_wy <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>%
   filter(lat >= wy_min_lat & lat <= wy_max_lat) %>% 
   filter(long >= wy_min_long & long <= wy_max_long) 

#bind together
sf <- rbind(aquasat_wy, aquasat_co, aquasat_id, aquasat_mt, aquasat_ut) %>%
  drop_na(chl_a) %>%
  filter(type == 'Lake') 

sf <- st_as_sf(sf, coords = c('long', 'lat'), crs = 4326)
```

#Use nhdtools::getwaterbodies to get the polygon data for all lakes within the aoi. Use st_nearest feature to join sf data to nhd polygons.
```{r}
wy_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = wy_min_long, xmax = wy_max_long, ymin = wy_min_lat, ymax = wy_max_lat),
                      crs = 4326))

nhd_wy <- get_waterbodies(AOI = wy_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
  filter(ftype == 'LakePond' | ftype == 'Reservoir')

co_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = co_min_long, xmax = co_max_long, ymin = co_min_lat, ymax = co_max_lat),
                      crs = 4326))

nhd_co <- get_waterbodies(AOI = co_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
  filter(ftype == 'LakePond' | ftype == 'Reservoir')

id_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = id_min_long, xmax = id_max_long, ymin = id_min_lat, ymax = id_max_lat),
                      crs = 4326))

nhd_id <- get_waterbodies(AOI = id_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
  filter(ftype == 'LakePond' | ftype == 'Reservoir')

mt_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = mt_min_long, xmax = mt_max_long, ymin = mt_min_lat, ymax = mt_max_lat),
                      crs = 4326))

nhd_mt <- get_waterbodies(AOI = mt_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
  filter(ftype == 'LakePond' | ftype == 'Reservoir')

ut_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = ut_min_long, xmax = ut_max_long, ymin = ut_min_lat, ymax = ut_max_lat),
                      crs = 4326))

nhd_ut <- get_waterbodies(AOI = ut_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
    filter(ftype == 'LakePond' | ftype == 'Reservoir')

nhd_aoi <- rbind(nhd_wy, nhd_co, nhd_id, nhd_mt, nhd_ut) %>%
    st_transform(st_crs(sf))

#Join all_comids to sf

sf <- st_join(sf, nhd_aoi, join = st_nearest_feature) 

```

#After joining AquaSat to NHD, now join LAGOS to NHD using the same method but retain the polygon geometry so we can then join the SF to LAGOS. 
```{r}
#having NHD df first will preserve polygon geometry

NHD_Lagos <- st_join(nhd_aoi, lagos_aoi, join = st_nearest_feature)

sf <- st_join(sf, NHD_Lagos, join = st_nearest_feature)

```

#Select relevant vars
```{r}

#Also, we will have to ditch all fields that have NAs for our random forest model. Going to have to ditch the lake names, and nhd data (depth, volume). We could also keep depth and drop na's after to see how well the model performs with less data but with depth included as a training feature. 

sf <- sf %>%
  select(lagoslakeid, lake_nhdid, ws_zoneid, hu12_zoneid, blue, green, nir, nir_sd, pixelCount, clouds, red, sat, swir1, swir2, date, chl_a, source, landsat_id, pwater, comid.x, lake_lat_decdeg, lake_lon_decdeg, lake_elevation_m) %>%
  rename(COMID = comid.x)

#Add LAGOS monthly hu12 climate data
climate <- read.csv(paste0(baseDir, '/CL_LAGOSUS_exports/LAGOSUS_GEO/GEO_EXPORT_BETA_v1/zone_climate_monthly1.csv')) %>%
  filter(zoneid %in% sf$hu12_zoneid) %>%
  select(zoneid, year, month, climate_tmean_degc, climate_tmax_degc, climate_ppt_mm)

#Add year-month field so we can join to sf  year-month

climate <- climate %>% mutate(year_month = ISOdate(climate$year, climate$month, 1))

climate$year_month <- format(climate$year_month, "%Y-%m")

climate <- climate %>%
  rename(hu12_zoneid = "zoneid")
  
##Do the same wrangling to sf df

#check date format - not necessarily needed
sf$date
sf$date <- ymd(sf$date)
sf$year_month <- format(sf$date, "%Y-%m")

#check
sf$year_month

sf <- left_join(sf, climate, by = c('hu12_zoneid', 'year_month'))
```

#Adding LakeCat data to sf for final df (https://www.epa.gov/national-aquatic-resource-surveys/lakecat-dataset-0)
```{r}

lakeCat <- tibble(COMID = unique(sf$COMID))  

lc.files <- list.files(paste0(baseDir,'/lakeCat'), full.names = TRUE)

for(i in lc.files){
  if(i == first(lc.files)){
    lc <- read.csv(i)
    lakeCat.full <- lakeCat %>%
      left_join(lc, by ='COMID')}
  else{
    lc <- read.csv(i) %>%
      select(-c(CatAreaSqKm, WsAreaSqKm, CatPctFull,WsPctFull,inStreamCat))
    lakeCat.full <- lakeCat.full %>%
      left_join(lc, by = 'COMID')
  }
}

round1 <- names(lakeCat.full %>% select(c(CatAreaSqKm:CatPctFull,PctImp2006Cat, PctCarbResidCat:WetIndexCat)))

round.1 <- names(lakeCat.full %>% select(c(AgKffactCat, KffactCat, MineDensCat)))

lakeCat.full <- lakeCat.full %>%
  mutate_at(round1, round, digits = 0) %>%
  mutate_at(round.1, round, digits = 1)

lakeCat.shrunk <- lakeCat.full %>%
  select("ClayCat", "SandCat", "OmCat", "PermCat", "RckdepCat", "BFICat", "CatAreaSqKm", "PctAg2006Slp10Cat", "NPDESDensCat", "HydrlCondCat", "PctImp2006Cat", "KffactCat", "RunoffCat", "WtDepCat", "WetIndexCat", "PctConif2006Cat", "PctMxFst2006Cat", "PctDecid2006Cat", "PctUrbHi2006Cat", "PctUrbMd2006Cat", "PctUrbLo2006Cat", "PctWdWet2006Cat", "PctWdWet2006Cat", "PctCrop2006Cat","NO3_2008Cat")

sf_final <- left_join(sf, lakeCat.shrunk, by = 'COMID')

write.csv(sf_final,'C:/Users/A/Dropbox (1)/training.csv")
```
