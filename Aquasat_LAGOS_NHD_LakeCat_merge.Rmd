---
title: "Aquasat_LAGOS_NHD_LakeCat_Merge: This code creates a training set for prediction of chlorophyll-a and/or categorical predictions (i.e. oligotrophic/mesotrophic/eutrophic). Lake point data (i.e. Aquasat and LAGOS), that do not contain common identifiers, are merged to nhd lake polygons to prevent potential mistakes in spatial joining. This can occur due to clustered lakes and inconsistent lake points. The combined Aquasat/LAGOS/NHD file is merged to lakeCat data by the common identifier comid"
date: 2-11-2022
author: S.Sillen
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Required packages
```{r}
library(tidyverse)
library(mapview)
library(lubridate)
library(sf)
library(leaflet)
library(leafgl)
library(nngeo)
library(LAGOSUS)
library(nhdplusTools)

baseDir <- "~/Dropbox (1)"

```

#Load in LAGOS/Aquasat data and filter it to roi (intermoutnain west states: WY,CO,UT,ID,MT). Filter Aquasat data to only include chl-a data.
```{r}
#lagos mt west states
mt_west_lagos <- read.csv(paste0(baseDir,"/CL_LAGOSUS_exports/LAGOSUS_LOCUS/LOCUS_v1.0/lake_information.csv")) %>%
  filter(lake_centroidstate == 'WY' | lake_centroidstate == 'CO' | lake_centroidstate == 'ID' | lake_centroidstate == 'MT' | lake_centroidstate == 'UT') %>%
  st_as_sf(coords=c("lake_lon_decdeg","lake_lat_decdeg"), crs=4326, remove=FALSE)  
  
#Aquasat does not include state field, so use min/max lat longs for aforementioned states to filter lat long data. 

#COLORADO
co_min_lat = 36.9949
co_max_lat = 41.0006
co_min_long = -109.0489
co_max_long = -102.0424

aquasat_co <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>% 
   filter(lat >= co_min_lat & lat <= co_max_lat) %>% 
   filter(long >= co_min_long & long <= co_max_long) 

#IDAHO
id_min_lat = 41.9871
id_max_lat = 49.0018
id_min_long = -117.2372
id_max_long = -111.0471

aquasat_id <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>%
   filter(lat >= id_min_lat & lat <= id_max_lat) %>% 
   filter(long >= id_min_long & long <= id_max_long) 
   
#MONTANA
mt_min_lat = 44.3563
mt_max_lat = 48.9991
mt_min_long = -116.0458
mt_max_long = -104.0186

aquasat_mt <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>% 
   filter(lat >= mt_min_lat & lat <= mt_max_lat) %>% 
   filter(long >= mt_min_long & long <= mt_max_long) 

#UTAH
ut_min_lat = 36.9982
ut_max_lat = 41.9993
ut_min_long = -114.0504
ut_max_long = -109.0462

aquasat_ut <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>%
   filter(lat >= ut_min_lat & lat <= ut_max_lat) %>% 
   filter(long >= ut_min_long & long <= ut_max_long) 

#WYOMING
wy_min_lat =  40.9986
wy_max_lat = 44.9988
wy_max_long =  -104.0556
wy_min_long = -111.0539

aquasat_wy <- read.csv(paste0(baseDir, "/sr_wq_rs_join.csv")) %>%
   filter(lat >= wy_min_lat & lat <= wy_max_lat) %>% 
   filter(long >= wy_min_long & long <= wy_max_long) 

#Bind all state data together
sf <- rbind(aquasat_wy, aquasat_co, aquasat_id, aquasat_mt, aquasat_ut) %>%
  drop_na(chl_a) %>%
  filter(type == 'Lake') 

#Check out spatial distribution of data to see if filtered data makes sense
leaflet(data = sf) %>%
  addTiles() %>%
  addMarkers(~long, ~lat)

#create sf before joining
sf <- st_as_sf(sf, coords = c('long', 'lat'), crs = 4326)
```

#Use nhdtools::getwaterbodies to get the COMIDs for all lakes within these states. Use st_nearest feature to join sf data to nhd polygons.
```{r}
wy_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = wy_min_long, xmax = wy_max_long, ymin = wy_min_lat, ymax = wy_max_lat),
                      crs = 4326))

wy_comids <- get_waterbodies(AOI = wy_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
  filter(ftype == 'LakePond' | ftype == 'Reservoir')

co_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = co_min_long, xmax = co_max_long, ymin = co_min_lat, ymax = co_max_lat),
                      crs = 4326))

co_comids <- get_waterbodies(AOI = co_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
  filter(ftype == 'LakePond' | ftype == 'Reservoir')

id_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = id_min_long, xmax = id_max_long, ymin = id_min_lat, ymax = id_max_lat),
                      crs = 4326))

id_comids <- get_waterbodies(AOI = id_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
  filter(ftype == 'LakePond' | ftype == 'Reservoir')

mt_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = mt_min_long, xmax = mt_max_long, ymin = mt_min_lat, ymax = mt_max_lat),
                      crs = 4326))

mt_comids <- get_waterbodies(AOI = mt_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
  filter(ftype == 'LakePond' | ftype == 'Reservoir')

ut_area <- sf::st_as_sfc(sf::st_bbox(c(xmin = ut_min_long, xmax = ut_max_long, ymin = ut_min_lat, ymax = ut_max_lat),
                      crs = 4326))

ut_comids <- get_waterbodies(AOI = ut_area, id = NULL, t_srs = NULL, buffer = 0.5) %>%
    filter(ftype == 'LakePond' | ftype == 'Reservoir')

all_comids <- rbind(wy_comids, co_comids, id_comids, mt_comids, ut_comids) %>%
    st_transform(st_crs(sf))

#Join all_comids to sf

sf <- st_join(sf, all_comids, join = st_nearest_feature) 

```

#After joining AquaSat to NHD, now join LAGOS to NHD using the same method but retain the polygon geometry so we can then join the SF to LAGOS. 
```{r}
#having NHD df first will preserve polygon geometry
NHD_Lagos <- st_join(all_comids, mt_west_lagos, join = st_nearest_feature)

sf <- st_join(sf, NHD_Lagos, join = st_nearest_feature)

```


#Above resulted in some weird field names / duplicates, so just select important vars
```{r}

#Also, we will have to ditch all fields that have NAs for our random forest model. Going to have to ditch the lake names, and nhd data (depth, volume). We could also keep depth and drop na's after to see how well the model performs with less data but with depth included as a training feature. 

sf <- sf %>%
  select(lagoslakeid, ws_zoneid, hu12_zoneid, blue, green, nir, nir_sd, pixelCount,clouds, red, sat, swir1, swir2, date, chl_a, source, landsat_id, pwater, comid.x, lake_lat_decdeg, lake_lon_decdeg, lake_elevation_m) %>%
  rename(comid = comid.x)

#Add landuse from 2006
Landuse <- read.csv(paste0(baseDir, "/CL_LAGOSUS_exports/LAGOSUS_GEO/GEO_EXPORT_BETA_v1/zone_landuse1.csv")) %>%
  filter(spatial_division == 'ws') %>%
  filter(year == 2006) 

#Have to rename sf ws_zoneid field to zoneid, convert zoneid field to character because ws_zoneid is a character, necessary to join the two
sf <- sf %>%
  rename(zoneid = ws_zoneid) %>%
  mutate(zoneid = as.character(zoneid))

#Add Landuse to sf 
sf <- left_join(sf, Landuse, by = 'zoneid') 

#Add LAGOS monthly hu12 climate data
climate <- read.csv(paste0(baseDir, '/CL_LAGOSUS_exports/LAGOSUS_GEO/GEO_EXPORT_BETA_v1/zone_climate_monthly1.csv')) %>%
  filter(zoneid %in% sf$hu12_zoneid) %>%
  select(zoneid, year, month, climate_tmean_degc, climate_tmax_degc, climate_ppt_mm)

#Add year-month field so we can join to sf  year-month

climate <- climate %>% mutate(year_month = ISOdate(climate$year, climate$month, 1))

climate$year_month <- format(climate$year_month, "%Y-%m")

climate <- climate %>%
  rename(hu12_zoneid = "zoneid")
  
#Do the same wrangling to sf df

#check date format - not necessarily needed
sf$date
sf$date <- ymd(sf$date)
sf$year_month <- format(sf$date, "%Y-%m")

#check
sf$year_month

sf <- left_join(sf, climate, by = c('hu12_zoneid', 'year_month'))
```

#Adding LakeCat data to sf for final df
```{r}
sf <- sf %>%
  rename(COMID = comid)

lakeCat <- tibble(COMID = unique(sf$COMID))  

lc.files <- list.files(paste0(baseDir,'/lakeCat'), full.names = TRUE)

for(i in lc.files){
  if(i == first(lc.files)){
    lc <- read.csv(i)
    lakeCat.full <- lakeCat %>%
      left_join(lc, by ='COMID')}
  else{
    lc <- read.csv(i) %>%
      select(-c(CatAreaSqKm, WsAreaSqKm, CatPctFull,WsPctFull,inStreamCat))
    lakeCat.full <- lakeCat.full %>%
      left_join(lc, by = 'COMID')
  }
}

round1 <- names(lakeCat.full %>% select(c(CatAreaSqKm:CatPctFull,PctImp2006Cat, PctCarbResidCat:WetIndexCat)))

round.1 <- names(lakeCat.full %>% select(c(AgKffactCat, KffactCat, MineDensCat)))

lakeCat.full <- lakeCat.full %>%
  mutate_at(round1, round, digits = 0) %>%
  mutate_at(round.1, round, digits = 1)

lakeCat.shrunk <- lakeCat.full %>%
  select("COMID", "KffactCat", "NO3_2008Cat",  "RunoffCat", "SlopeCat", "WtDepCat", "WetIndexCat")

sf_final <- left_join(sf, lakeCat.shrunk, by = 'COMID')

write.csv(sf_final,'C:/Users/A/Dropbox (1)/sf_training.csv')
```
