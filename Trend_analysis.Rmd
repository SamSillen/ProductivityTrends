---
title: "Trend_analysis"
author: "S. Sillen"
date: '2022-06-09'
output: html_document
---

Required Packages
```{r}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(ggpubr)
```


Workflow
```{r}

# 1) Read in sf file ; filter to summer obs > 3 per year ; determine percetage of trophic state observation per year per lake

# 2) Summarise (average) classes across 2 time frames (1984-2005) (2005-2020)

# 3) Identify no change lakes, lakes trending eutrophic, and lakes trending oligotrophic
```

1) Read in preds file ; filter to summer obs > 3 per year ; determine percetage of trophic state observation per year per lake
```{r}
preds <- read.csv("C:/Users/samsi/Dropbox/preds.csv") %>%
  mutate(pred = case_when(pred==0~'oligotrophic',
                                pred==1~'mesotrophic',
                                pred==2~'eutrophic')) %>%
  mutate(month = month(date, label = TRUE)) %>%
  mutate(year = as.integer(year)) %>%
  filter(type == 'dp',
         month %in% c('Jun', 'Jul', 'Aug', 'Sep')) %>%
  mutate(year = year(date)) %>%
  group_by(lagoslakeid, year) %>%
  filter(n() >= 3) %>%
  ungroup()

#Make sure only keeping consecutive observations (i.e. the code above only keeps years where there are three observations per year, but includes gaps; the code below drops all of the lakes with gaps)

df <- preds %>%
  distinct(lagoslakeid, year)

df <- df %>% 
  group_by(lagoslakeid) %>% 
  arrange(year, lagoslakeid) %>%
  mutate(deltaLag1 = year - lag(year, 1)) 

df <- df %>%
  filter(deltaLag1 > 1)

preds <- preds %>%
  filter(!lagoslakeid %in% df$lagoslakeid)

#create fields for percentages of oligo/meso/eutro per lakeid per year

yearly_obs <- preds %>%
  group_by(lagoslakeid, year) %>%
  summarise(total_obs = n()) %>%
  ungroup()

trophic_states <- c('oligotrophic', 'mesotrophic', 'eutrophic')

for (i in trophic_states) {
    state <- preds %>%
      filter(pred == i) %>%
      group_by(year,lagoslakeid) %>%
      summarise(count = n())
    yearly_obs <- left_join(yearly_obs, state, by = c('year', 'lagoslakeid'))
}

yearly_obs <- yearly_obs %>%
  mutate_all(funs(replace_na(.,0))) %>%
  rename(count_oligotrophic = 'count.x',
         count_mesotrophic = 'count.y',
         count_eutrophic = 'count') %>%
  mutate(pct_oligotrophic = (count_oligotrophic / total_obs)*100,
         pct_mesotrophic = (count_mesotrophic / total_obs)*100,
         pct_eutrophic = (count_eutrophic / total_obs)*100) 
```

2) Summarise (average) classes across 2 time frames (1984-2005 == 'early') (2005-2020 == 'late')
```{r}

early <- yearly_obs %>%
  filter(year < 2005) %>%
  group_by(lagoslakeid) %>%
  summarise(early_mean_oligotrophic = mean(pct_oligotrophic), early_mean_mesotrophic = mean(pct_mesotrophic), early_mean_eutrophic = mean(pct_eutrophic))

late <- yearly_obs %>%
  filter(year > 2005) %>%
  group_by(lagoslakeid) %>%
  summarise(late_mean_oligotrophic = mean(pct_oligotrophic), late_mean_mesotrophic = mean(pct_mesotrophic), late_mean_eutrophic = mean(pct_eutrophic))

trends <- left_join(early, late, by = 'lagoslakeid')

trends <- trends %>%
    mutate(oligotrophic_delta = (late_mean_oligotrophic - early_mean_oligotrophic),
          mesotrophic_delta = (late_mean_mesotrophic - early_mean_mesotrophic),
          eutrophic_delta = (late_mean_eutrophic - early_mean_eutrophic))
```

3) Identify no change lakes, lakes trending eutrophic, and lakes trending oligotrophic
```{r}

no_trend <- trends %>%
  filter(oligotrophic_delta < 10 & oligotrophic_delta >-10, 
         mesotrophic_delta < 10 & mesotrophic_delta > -10, 
         eutrophic_delta < 10 & eutrophic_delta > -10) %>%
  mutate(trend = 'no trend')

trending_eutrophic <- trends %>%
  filter(eutrophic_delta > 10, oligotrophic_delta < -10) %>%
  mutate(trend = 'trending_eutrophic')

trending_oligotrophic <- trends %>%
  filter(oligotrophic_delta > 10 , eutrophic_delta < 0) %>%
  mutate(trend = 'trending oligotrophic')

trends <- rbind(no_trend, trending_eutrophic, trending_oligotrophic)

write.csv(trends, "C:/Users/samsi/Dropbox/WesternMountainsChlPreds/csvs/trends.csv")
```


The following code creates Figure 2: Examples of possible trend categories based on the trends in % occurrence of trophic states.  
```{r}
#no trend

i.e.no_trend <- no_trend %>%
  sample_n(1)

i.e.no_trend <- yearly_obs %>%
  filter(lagoslakeid %in% i.e.no_trend$lagoslakeid) %>%
  rename(Oligotrophic = "pct_oligotrophic", 
         Mesotrophic = "pct_mesotrophic",
          Eutrophic = "pct_eutrophic") %>%
  pivot_longer(cols = c("Oligotrophic", "Mesotrophic", "Eutrophic"), names_to = "Trophic_State")

i.e.no_trend$Trophic_State <- factor(i.e.no_trend$Trophic_State, levels = c('Eutrophic', "Mesotrophic", "Oligotrophic"))


i.e.no_trend_plot <- ggplot(i.e.no_trend, aes(x = year, y = value, fill = Trophic_State)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c( '#7dae38',  '#698c86', '#2158bc')) +
  labs(title = "A) No trend") +
  xlab("Year") +
  ylab("% Occurence") +
  theme_bw() +
  theme(legend.title = element_blank(), axis.title = element_text(size = 30), axis.text = element_text(size = 24, color = 'black'), legend.text = element_text(size = 30), title = element_text(size = 30, face = 'bold'))

i.e.no_trend
# increasing oligotrophic

i.e.trending_oligotrophic <- trending_oligotrophic %>%
  sample_n(1)

i.e.trending_oligotrophic <- yearly_obs %>%
  filter(lagoslakeid %in% i.e.trending_oligotrophic$lagoslakeid) %>%
  rename(Oligotrophic = "pct_oligotrophic", 
         Mesotrophic = "pct_mesotrophic",
          Eutrophic = "pct_eutrophic") %>%
  pivot_longer(cols = c("Oligotrophic", "Mesotrophic", "Eutrophic"), names_to = "Trophic_State")

i.e.trending_oligotrophic$Trophic_State <- factor(i.e.trending_oligotrophic$Trophic_State, levels = c('Eutrophic', "Mesotrophic", "Oligotrophic"))


i.e.oligotrophic_plot <- ggplot(i.e.trending_oligotrophic, aes(x = year, y = value, fill = Trophic_State)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c( '#7dae38',  '#698c86', '#2158bc')) +
  labs(title = "B) Increasing in % Oligotrophic") +
  xlab("Year") +
  ylab("% Occurence") +
  theme_bw() +
  theme(legend.title = element_blank(), axis.title = element_text(size = 30), axis.text = element_text(size = 24, color = 'black'), legend.text = element_text(size = 30), title = element_text(size = 30, face = 'bold'))

i.e.oligotrophic_plot

# increasing eutrophic

i.e.trending_eutrophic <- trending_eutrophic %>%
  sample_n(1)

i.e.trending_eutrophic <- yearly_obs %>%
  filter(lagoslakeid %in% i.e.trending_eutrophic$lagoslakeid) %>%
  rename(Oligotrophic = "pct_oligotrophic", 
         Mesotrophic = "pct_mesotrophic",
          Eutrophic = "pct_eutrophic") %>%
  pivot_longer(cols = c("Oligotrophic", "Mesotrophic", "Eutrophic"), names_to = "Trophic_State")

i.e.trending_eutrophic$Trophic_State <- factor(i.e.trending_eutrophic$Trophic_State, levels = c('Eutrophic', "Mesotrophic", "Oligotrophic"))


i.e.eutrophic_plot <- ggplot(i.e.trending_eutrophic, aes(x = year, y = value, fill = Trophic_State)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c( '#7dae38',  '#698c86', '#2158bc')) +
  labs(title = "C) Increasing in % Eutrophic") +
  xlab("Year") +
  ylab("% Occurence") +
  theme_bw() +
  theme(legend.title = element_blank(), axis.title = element_text(size = 30), axis.text = element_text(size = 24, color = 'black'), legend.text = element_text(size = 30), title = element_text(size = 30, face = 'bold'))

i.e.eutrophic_plot

example_trends_plot <- ggarrange(i.e.no_trend_plot, i.e.oligotrophic_plot, i.e.eutrophic_plot)

example_trends_plot

```

